# ì§€ë‚œ ì£¼ ëª©í‘œ
ë¡œê¹… ì—°ë™ 

# ì™„ë£Œí•œ ì‘ì—…
### 1. ë¡œê¹… ì—°ë™ êµ¬ì¡° ë³€ê²½ (ë¡œê·¸ ìˆ˜ì§‘ê¸° : Promtail â†’ Fluent Bit)
- ê¸°ì¡´ì—ëŠ” íŒŒì¼ì— ì§ì ‘ ë¡œê·¸ë¥¼ ì¨ì„œ ë¡œê·¸ íŒŒì¼ì„ ìˆ˜ì§‘í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ì§„í–‰í•˜ë ¤ê³  í–ˆì–´ì„œ, ë¡œê·¸ ìˆ˜ì§‘ê¸°ë¡œ Promtail ì´ë¼ëŠ” ê²ƒì„ ì‚¬ìš©í–ˆë‹¤. 
- ë¡œê·¸ íŒŒì¼ë¡œ ë‚¨ê¸°ëŠ” ëŒ€ì‹  stdout ìœ¼ë¡œ ë¡œê·¸ë¥¼ ì¶œë ¥í•˜ê³  fluent bit ë¡œ ë¡œê·¸ë¥¼ ì „ì†¡í•˜ëŠ” ë°©ì‹ì´ ìˆë‹¤ê³  í•´ì„œ Promtail ëŒ€ì‹  Fluent Bit ì‚¬ìš©í•˜ê¸°ë¡œ í•¨ 

**ğŸ’¡ Promtail ì´ ì í•©í•œ ê²½ìš°**
- ë¡œê·¸ë¥¼ íŒŒì¼ì— ë‚¨ê¸°ëŠ” ê²½ìš° 
- ë¡œê·¸ íŒŒì¼ ê²½ë¡œê°€ ëª…í™•í•œ ê²½ìš°
- ì‹œìŠ¤í…œ ë¡œê·¸, ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸ë¥¼ ì§ì ‘ tail í•˜ê³  ì‹¶ì„ ë•Œ 

**ğŸ’¡ Fluent Bit ê°€ ì í•©í•œ ê²½ìš°**
- ë¡œê·¸ë¥¼ ìˆ˜ì§‘í•  ì„œë¹„ìŠ¤(ì»¨í…Œì´ë„ˆ)ê°€ ë§ì€ ê²½ìš°
- stdoutë¡œ ì¶œë ¥ë˜ëŠ” ë¡œê·¸ ìˆ˜ì§‘í•˜ê³  ì‹¶ì€ ê²½ìš°
- ë¦¬ì†ŒìŠ¤ë¥¼ ì ê²Œ ë“¤ì´ê³  ì‹¶ì„ ë•Œ (C ì–¸ì–´ ê¸°ë°˜ì´ë¼ ë¹ ë¥´ê³  ê°€ë²¼ì›€)


```
[As-Is]
+----------------+       +----------------+       +-------------+ 
| Application(s) |  -->  | Promtail       |  -->  | Loki        | 
|                |       | (ë¡œê·¸ ìˆ˜ì§‘ê¸°)     |       | (ì €ì¥ & ê²€ìƒ‰) | 
+----------------+       +----------------+       +-------------+ 

[To-Be]
+----------------+       +----------------+       +-------------+ 
| Application(s) |  -->  | Fluent Bit     |  -->  | Loki        | 
|                |       | (ë¡œê·¸ ìˆ˜ì§‘ê¸°)     |       | (ì €ì¥ & ê²€ìƒ‰) | 
+----------------+       +----------------+       +-------------+ 
```
### 2. ë¡œê·¸ ìˆ˜ì§‘í•˜ë ¤ëŠ” ì„œë¹„ìŠ¤ì˜ docker-compose.yml ì‘ì—… í•„ìš”
**services > logging í•­ëª© ì¶”ê°€** 
- `driver: fluentd` : ë¡œê·¸ ë“œë¼ì´ë²„ë¥¼ fluentd ë¡œ ì§€ì •í•œë‹¤. 
  - stdout/stderr ë¡œê·¸ë¥¼ Fluent Bit ë¡œ ì§ì ‘ ì „ì†¡í•œë‹¤. 
- `options`
  - `fluentd-address: localhost:24224` : Fluent Bit ê°€ ë¡œê·¸ë¥¼ ìˆ˜ì‹ í•  ì£¼ì†Œ:í¬íŠ¸
  - `tag: mmb-ms-msa-playground` : ë¡œê·¸ë§ˆë‹¤ ë¶™ì¼ íƒœê·¸ (MSA í™˜ê²½ì—ì„œëŠ” ì„œë¹„ìŠ¤ëª…ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¢‹ìŒ)
```
services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    image: mumulbo/mmb-ms-msa-playground:IMAGE_TAG_PLACEHOLDER
    env_file:
      - .env
    ports:
      - "${SERVICE_PORT}:8084"
    networks:
      - external-net
    depends_on:
      - db
    logging:
        driver: fluentd
        options:
            fluentd-address: localhost:24224
            tag: mmb-ms-msa-playground
```

### 3. Fluent Bit ì»¨í…Œì´ë„ˆ ë„ìš°ê¸° 
**1) fluent-bit.conf íŒŒì¼ ì‘ì„±**
```
[SERVICE]
  HTTP_Server   On
  HTTP_Listen   0.0.0.0
  HTTP_Port     2020
  Log_Level     info

[INPUT]
  Name    forward
  Listen  0.0.0.0
  Port    24224

[OUTPUT]
  Name    loki
  Match   *
  Host    mmb-loki
  Port    3100
  Labels  job=docker_logs,service=$service
```
- OUTPUT ì— loki ì„¤ì •í•¨ìœ¼ë¡œì¨ loki ì—ì„œëŠ” ë³„ë„ë¡œ Fluent Bit ë¥¼ ë°›ê¸°ìœ„í•œ ì„¤ì • ì•ˆí•´ì¤˜ë„ ë¨
- (ì°¸ê³ ) service ëª…ì— ê³„ì† docker_logs ê°€ ì¶œë ¥ë˜ì–´ì„œ extract_tag.lua ë¼ëŠ” íŒŒì¼ ì¶”ê°€í•´ì¤Œ

**2) ëª¨ë‹ˆí„°ë§ ì„œë¹„ìŠ¤ docker-compose.yml ì— fluentbit ì¶”ê°€**
```
  mmb-fluentbit:
    image: grafana/fluent-bit-plugin-loki
    platform: linux/amd64
    container_name: mmb-fluentbit
    ports:
      - "${FLUENTBIT_LOKI_PORT}:24224"  # Fluent Bit forward input í¬íŠ¸
      - "${FLUENTBIT_PORT}:2020"  # Fluent Bit ìƒíƒœ í™•ì¸ í¬íŠ¸
    volumes:
      - ./fluentbit/fluent-bit.conf:/fluent-bit/etc/fluent-bit.conf
      - ./fluentbit/extract_tag.lua:/fluent-bit/scripts/extract_tag.lua:ro
    networks:
      - mgt-net
```
**3) docker compose up ìˆ˜í–‰**
![](../../9_images/w10_fluentbit.jpg)
```
â—ï¸ì£¼ì˜í•  ì‚¬í•­ (ì»¨í…Œì´ë„ˆ ë„ìš°ëŠ” ìˆœì„œ) â—ï¸

[mmb-monitoring-stack] â†’ [mmb-(ë¡œê·¸ ì°ëŠ” ì„œë¹„ìŠ¤)] 
```
- ì„œë¹„ìŠ¤ ë¨¼ì € ë„ìš°ë ¤ê³  í•˜ë©´ fluentd ì—†ë‹¤ê³  ì—ëŸ¬ë‚˜ì„œ ëª»ëœ¸
- ì„œë¹„ìŠ¤ì˜ docker-compose.yml ì— logging driver ë¡œ fluentd ë¥¼ ì„¤ì •í•´ë†“ì•˜ê¸° ë•Œë¬¸ì—, 
- ê¼­ fluentd ë¥¼ ì»¨í…Œì´ë„ˆë¡œ ë¨¼ì € ë„ìš°ê³  ë‚œ ë‹¤ìŒì— ì„œë¹„ìŠ¤ë¥¼ ë„ì›Œì•¼ í•œë‹¤. 

**4) ë¡œê·¸ ìƒì„±í•˜ê³  Grafana ì—ì„œ í™•ì¸**
![](../../9_images/w10_log.jpg)
![](../../9_images/w10_grafana.jpg)
- service ëª…ìœ¼ë¡œ ê²€ìƒ‰í–ˆì„ ë•Œ ìˆ˜ì§‘í•œ ë¡œê·¸ ì¶œë ¥ë¨ 


# ì§„í–‰ ì¤‘ì¸ ì‘ì—…
**ğŸ’¢ í™•ì¸ ë° ê°œì„  í•„ìš”í•œ ì‚¬í•­**
- ëª¨ë‹ˆí„°ë§ ì„œë¹„ìŠ¤(mmb-monitoring-stack) up í•˜ê³  í…ŒìŠ¤íŠ¸ ì„œë¹„ìŠ¤(mms-ms-playground) up í•˜ë©´ í…ŒìŠ¤íŠ¸ ì„œë¹„ìŠ¤ê°€ ë–´ë‹¤ê°€ ì£½ìŒ 
  - ê·¼ë° ë‹¤ì‹œ up í•˜ë©´ ì˜ ë¨ 
  - ì›ì¸ íŒŒì•… í•„ìš” ,, 
- ì¼ë‹¨ grafana ì—ì„œ ë³´ì´ëŠ” ê²ƒê¹Œì§€ë§Œ í™•ì¸í•´ì„œ ê·¸ ì´í›„ ì‘ì—… í•„ìš” .. 
- ë‚´ê°€ í™•ì¸í•˜ê³  ì‹¶ì€ ë¡œê·¸ë§Œ í•„í„°ë§
- ì„¤ì • íŒŒì¼ ë“± ì¢€ ë” ë‹¨ìˆœí™”í•  ìˆ˜ ìˆëŠ”ì§€
- ì–´ë–¤ ë¡œê·¸ ì–´ë–»ê²Œ ëª¨ë‹ˆí„°ë§í•  ì§€ 


# ë°°ìš´ ì 


# ê°œì„ í•  ì 
`ì§„í–‰ ì¤‘ì¸ ì‘ì—…`ê³¼ ë™ì¼í•©ë‹ˆë‹¤

# ê¸°íƒ€ ê³µìœ  ì‚¬í•­
None

# ë‹¤ìŒ ì£¼ ê³„íš
`ì§„í–‰ ì¤‘ì¸ ì‘ì—…`ê³¼ ë™ì¼í•©ë‹ˆë‹¤
