# Docker Compose 작성 가이드

- 리소스 제한 방법
- DB 실행 후 애플리케이션 실행 방법

# Docker Compose 예제

- Spring Boot + MariaDB 기준

```yaml
services:
  app:
    image: your-spring-boot-app:latest
    container_name: spring-app
    build:
      context: .
    ports:
      - "8080:8080"
    depends_on:
      db:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:mariadb://db:3306/app_db
      SPRING_DATASOURCE_USERNAME: app_user
      SPRING_DATASOURCE_PASSWORD: app_pass
    mem_limit: 384m
    cpus: 0.5

  db:
    image: mariadb:11.3
    container_name: mariadb
    environment:
      MYSQL_ROOT_PASSWORD: rootpass
      MYSQL_DATABASE: app_db
      MYSQL_USER: app_user
      MYSQL_PASSWORD: app_pass
    ports:
      - "3306:3306"
    mem_limit: 256m
    cpus: 0.3
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost" ]
      interval: 5s
      timeout: 5s
      retries: 5
```

# 구성 요소 설명

## DB 헬스 체크

* `healthcheck`: DB가 실제로 연결 가능한 상태인지 주기적으로 확인
    * test: 명령어 실행 결과로 컨테이너의 상태를 판단
    * interval: health check를 실행할 간격 (5초마다)
    * timeout: 명령 실행 제한 시간
    * retries: 실패 횟수가 이만큼 누적되면 unhealthy 상태로 판단

### Redis 예제

```yaml
redis:
  image: redis:7
  ports:
    - "6379:6379"
  mem_limit: 128m
  cpus: 0.2
  healthcheck:
    test: [ "CMD", "redis-cli", "ping" ]
    interval: 5s
    timeout: 5s
    retries: 5
```

### Oracle XE (gvenzl/oracle-xe) 예제

```yaml
oracle:
  image: gvenzl/oracle-xe
  ports:
    - "1521:1521"
  environment:
    ORACLE_PASSWORD: oracle
  mem_limit: 768m
  cpus: 0.7
  healthcheck:
    test: [ "CMD-SHELL", "echo 'exit' | sqlplus -L system/oracle@localhost/XEPDB1" ]
    interval: 10s
    timeout: 10s
    retries: 10
```

## DB 실행 후 애플리케이션 실행

- `depends_on.db.condition: service_healthy`
- depends_on의 기본 동작은 단순히 DB 컨테이너를 먼저 시작시키는 것이며, 상태 확인은 하지 않음.
- condition: service_healthy를 추가하면 healthcheck 결과가 'healthy'가 될 때까지 기다림

## 컨테이너 리소스 제한

* `mem_limit`: 컨테이너가 사용할 수 있는 최대 메모리 (예: 256m → 256MB)
* `cpus`: 컨테이너가 사용할 수 있는 CPU 비율 (예: 0.3 → 전체의 30%)
* **JDK 17 이상에서는 JVM이 이 제한을 자동 인식하여 힙/GC 등을 조정**하므로 별도 JVM 설정 없이도 안정적

