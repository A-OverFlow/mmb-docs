# ê°œìš”

> MSA í™˜ê²½ì— ì„œë¹„ìŠ¤(í”„ë¡œì íŠ¸)ê°€ ë°°í¬ë  ìˆ˜ ìˆë„ë¡ ì„¤ì •í•˜ëŠ” ë°©ë²•ì„ ëª…ì‹œí•œë‹¤.

## ê°€ì´ë“œê°€ í•„ìš”í•œ ì´ìœ 

1. ì„œë¹„ìŠ¤ ë‹¨ìœ„ ê°œë°œ ë° ë°°í¬ëŠ” MSAì˜ í•µì‹¬ì´ë‹¤
2. ì„œë¹„ìŠ¤ ê°œë°œìì™€ ë°°í¬ ë‹´ë‹¹ì ëª¨ë‘ í•´ë‹¹ ê³¼ì •ì„ ì´í•´í•˜ê³  ìˆì–´ì•¼ ì›í™œí•œ ë°°í¬ê°€ ê°€ëŠ¥í•˜ë‹¤
3. MSA í™˜ê²½ì— ì„œë¹„ìŠ¤ê°€ ìë™ìœ¼ë¡œ ë°°í¬ë  ë•Œ ê±°ì¹˜ëŠ” ê³¼ì •ì´ ë³µì¡í•˜ë‹¤
4. ë”°ë¼ì„œ, ëª¨ë“  ì„œë¹„ìŠ¤(í”„ë¡œì íŠ¸)ì— ì¼ê´€ëœ ë°°í¬ ì„¤ì •ì´ í•„ìš”í•˜ë‹¤

# ì „ì²´ íë¦„

1. ë¡œì»¬ (ê°œë°œì í™˜ê²½)
    1. ì„œë¹„ìŠ¤ ê°œë°œ
    2. í…ŒìŠ¤íŠ¸
        1. í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‘ì„± ë° ì‹¤í–‰
        2. í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰í•˜ì—¬ í…ŒìŠ¤íŠ¸
            1. application-local.yml -> ë¡œì»¬ í™˜ê²½ì— ë§ê²Œ ëª¨ë“  ê°’ í•˜ë“œì½”ë”©
        3. ì»¨í…Œì´ë„ˆë¡œ ì‹¤í–‰í•˜ì—¬ í…ŒìŠ¤íŠ¸
            1. docker-compose.yml
            2. .env -> í‚¤ë§Œ ì¡´ì¬í•˜ê³  ê°’ì€ ì—†ìŒ. local í™˜ê²½ì— ë§ê²Œ ì„¤ì •í•˜ì—¬ ì‚¬ìš©.
    3. í†µí•© í…ŒìŠ¤íŠ¸ -> í•„ìˆ˜ëŠ” ì•„ë‹ˆì§€ë§Œ í•„ìš”í•œ ê²½ìš° ê°€ëŠ¥í•´ì•¼ í•¨
        1. ì „ì²´ í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰í•˜ì—¬ í…ŒìŠ¤íŠ¸
        2. ì „ì²´ ì»¨í…Œì´ë„ˆ ì‹¤í–‰í•˜ì—¬ í…ŒìŠ¤íŠ¸
    4. dev ë¸Œëœì¹˜ì— push (PR)
2. ê¹ƒí—ˆë¸Œ (ë¹Œë“œì„œë²„)
    1. ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ ë° Docker Hubì— push
    2. ê¹ƒí—ˆë¸Œ ì•¡ì…˜ ë‹¨ê³„ì—ì„œ ê¹ƒí—ˆë¸Œ ì‹œí¬ë¦¿ ì°¸ì¡°í•˜ì—¬ .env ìƒì„±
    3. docker-compose.yml + .env â†’ ì„œë²„ ì „ì†¡
3. ê°œë°œ (ê°œë°œ ì„œë²„)
    1. ê³µí†µ ì„¤ì •ê³¼ í•¨ê»˜ ë„ì»¤ ì»´í¬ì¦ˆ ì‹¤í–‰
    2. ë°°í¬ ì™„ë£Œ
4. ìš´ì˜ (ìš´ì˜ ì„œë²„)
    1. dev ë¸Œëœì¹˜ prod ë¸Œëœì¹˜ë¡œ merge
    2. (ì´í›„ ê°œë°œ ì„œë²„ì™€ ê°™ì€ ì ˆì°¨ë¡œ ìš´ì˜ ì„œë²„ì— ë°°í¬)

# ìƒì„¸ êµ¬ì¡°

## ì„œë¹„ìŠ¤ ì €ì¥ì†Œ (ì˜ˆ: mmb-member-service)

```plaintext
mmb-member-service/
â”œâ”€â”€ application.yml             â† ê³µí†µ ì„¤ì •
â”œâ”€â”€ application-local.yml       â† ë¡œì»¬ ì„¤ì •
â”œâ”€â”€ application-dev.yml         â† ê°œë°œ ì„¤ì •
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ docker-compose.yml          â† ë„¤íŠ¸ì›Œí¬ ì„¤ì • ì—†ìŒ
â”œâ”€â”€ .env                        â† ë¡œì»¬ ì „ìš©, ê°’ì€ ì—†ê³  í‚¤ë§Œ ìˆìŒ. ex) NAME=
â””â”€â”€ .github/
    â””â”€â”€ workflows/
        â””â”€â”€ deploy-dev.yml      â† ì„œë²„ ë°°í¬ìš© GitHub Actions ì„¤ì • íŒŒì¼
```

### ex) application.yml

```yaml
spring:
  jpa:
    hibernate:
      ddl-auto: update
    show-sql: true
    properties:
      hibernate:
        format_sql: true
    database-platform: org.hibernate.dialect.MySQL8Dialect

logging:
  level:
    org.springframework: INFO
    com.example.member: DEBUG
```

- ê³µí†µ ì„¤ì •

### ex) application-local.yml

```yaml
spring:
  profiles:
    active: local

  datasource:
    url: jdbc:mysql://localhost:3306/member_db
    username: root
    password: localpass
    driver-class-name: com.mysql.cj.jdbc.Driver

server:
  port: 8080
```

- ë¡œì»¬ ê°œë°œìš©, ê°’ ì§ì ‘ ì„¤ì •
- ê°œë°œìëŠ” ë³„ë„ `.env` ì—†ì´ë„ ë°”ë¡œ ì‹¤í–‰ ê°€ëŠ¥
- `localhost` ê¸°ë°˜ DB ì—°ê²° (ì›í•˜ëŠ” í™˜ê²½ìœ¼ë¡œ ì„¤ì •)

### ex) application-dev.yml

```yaml
spring:
  profiles:
    active: dev

  datasource:
    url: ${DB_URL}
    username: ${DB_USERNAME}
    password: ${DB_PASSWORD}
    driver-class-name: com.mysql.cj.jdbc.Driver

server:
  port: ${PORT}
```

- ê°œë°œ ì„œë²„ìš©, í™˜ê²½ ë³€ìˆ˜ ì£¼ì… ê¸°ë°˜
- `.env` â†’ `docker-compose.yml` â†’ Spring í™˜ê²½ ë³€ìˆ˜ ì „ë‹¬
- ìœ ì—°í•˜ê²Œ í™˜ê²½ì— ë”°ë¼ ì‹¤í–‰

### ex) docker-compose.yml

```yaml
version: "3.8"

services:
  member-service:
    image: your-id/mmb-member-service:${SPRING_PROFILE}
    ports:
      - "${PORT}:8080"
    env_file:
      - .env
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILE}
      - DB_URL=jdbc:mysql://member-db:3306/member_db
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
    depends_on:
      - member-db

  member-db:
    image: mysql:8
    container_name: member-db
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_DATABASE: member_db
    ports:
      - "${DB_PORT}:3306"
    volumes:
      - ${DB_VOLUME_PATH}:/var/lib/mysql
```

- ë¡œì»¬ì—ì„  `default` ë„¤íŠ¸ì›Œí¬ ìë™ ì—°ê²°
- ì„œë²„ì—ì„  ê³µí†µ ì»´í¬ì¦ˆ íŒŒì¼ ì‚¬ìš©í•˜ì—¬ ì„œë¹„ìŠ¤ ì»´í¬ì¦ˆ íŒŒì¼ê³¼ ë„¤íŠ¸ì›Œí¬ ì„¤ì •ì„ ë³‘í•©

### ex) .env

```plaintext
SPRING_PROFILE=
PORT=
SPRING_PROFILE=
DB_USERNAME=
DB_PASSWORD=
DB_PORT=
DB_VOLUME_PATH=
```

- í‚¤ë§Œ ì¡´ì¬í•˜ê³  ê°’ì€ ì—†ëŠ” ìŠ¤ì¼ˆë ˆí†¤ í˜•íƒœ
- í•„ìš”í•œ í™˜ê²½ ë³€ìˆ˜ ëª©ë¡ì„ ëª…ì‹œì ìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆìŒ
- ë¡œì»¬ì—ì„œëŠ” í•´ë‹¹ ê°’ì„ ì±„ìš°ê³  docker compose ì‹¤í–‰í•˜ì—¬ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŒ
- ê°’ì„ ì±„ìš´ ìƒíƒœë¡œ ì»¤ë°‹í•˜ì§€ ì•ŠìŒ (ìŠ¤ì¼ˆë ˆí†¤ í˜•íƒœ ìœ ì§€)

### ex) .github/workflows/deploy-dev.yml

```yaml
name: Deploy to Dev Server

on:
  push:
    branches: [ dev ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      IMAGE_NAME: your-dockerhub-id/mmb-member-service
      TAG: dev

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.IMAGE_NAME }}:${{ env.TAG }}

      - name: Generate .env file from secrets
        run: |
          echo "IMAGE=${{ env.IMAGE_NAME }}:${{ env.TAG }}" > .env
          echo "PORT=8082" >> .env
          echo "SPRING_PROFILE=dev" >> .env
          echo "DB_URL=${{ secrets.DB_URL }}" >> .env
          echo "DB_USERNAME=${{ secrets.DB_USERNAME }}" >> .env
          echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
          echo "NETWORK_NAME=msa-net" >> .env

      - name: Upload docker-compose.yml and .env to Dev Server
        uses: appleboy/scp-action@v0.1.3
        with:
          host: ${{ secrets.DEV_SSH_HOST }}
          username: ${{ secrets.DEV_SSH_USER }}
          key: ${{ secrets.DEV_SSH_PRIVATE_KEY }}
          source: "docker-compose.yml,.env"
          target: "~/msa-deploy/mmb-member-service"

      - name: Deploy on Dev Server
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.DEV_SSH_HOST }}
          username: ${{ secrets.DEV_SSH_USER }}
          key: ${{ secrets.DEV_SSH_PRIVATE_KEY }}
          script: |
            cd ~/msa-deploy/mmb-member-service
            docker compose \
              -f ../docker-compose.common.yml \
              -f docker-compose.yml \
              --env-file .env \
              up -d

```

- ê¹ƒí—ˆë¸Œ ì‹œí¬ë¦¿ì„ ì°¸ì¡°í•˜ì—¬ ê°œë°œ ì„œë²„ì—ì„œ ì‚¬ìš©í•  `.env` íŒŒì¼ ìƒì„±
- ì„œë¹„ìŠ¤(í”„ë¡œì íŠ¸)ì— ì¡´ì¬í•˜ëŠ” `docker-compose.yml` íŒŒì¼ì„ ê°œë°œ ì„œë²„ë¡œ ë³µì‚¬
- ê°œë°œ ì„œë²„ì— ì¡´ì¬í•˜ëŠ” `docker-compose.common.yml` íŒŒì¼ê³¼ ë³‘í•©í•˜ì—¬ ì„œë¹„ìŠ¤ ì‹¤í–‰

## ê°œë°œ ì„œë²„

```plaintext
~/msa-deploy/
â”œâ”€â”€ docker-compose.common.yml     â† ê³µí†µ ë„¤íŠ¸ì›Œí¬ ì •ì˜ + ì„œë¹„ìŠ¤ ë„¤íŠ¸ì›Œí¬ ì„¤ì •
â”œâ”€â”€ mmb-member-service/               â† ì„œë¹„ìŠ¤ ë³„ë¡œ ë””ë ‰í† ë¦¬ ìƒì„±ë¨
â”‚   â”œâ”€â”€ docker-compose.yml        â† ì„œë¹„ìŠ¤(í”„ë¡œì íŠ¸)ì—ì„œ ë³µì‚¬í•´ì˜¨ íŒŒì¼
â”‚   â””â”€â”€ .env                      â† GitHub Actionsì—ì„œ GitHub Secret ì°¸ì¡°í•˜ì—¬ ìƒì„±
â”œâ”€â”€ mmb-frontend/
â”‚   â””â”€â”€ ...
â””â”€â”€ scripts/                      â† ì „ì²´ ì„œë¹„ìŠ¤ ì‹¤í–‰ ë° ì¢…ë£Œ ìŠ¤í¬ë¦½íŠ¸
    â”œâ”€â”€ start-all.sh
    â””â”€â”€ stop-all.sh
```

### ex) docker-compose.common.yml

```yaml
version: "3.8"

services:
  mmb-member-service:
    networks:
      - msa-net

  mmb-auth-service:
    networks:
      - msa-net

networks:
  msa-net:
    driver: bridge
```

- ê³µí†µ ë„¤íŠ¸ì›Œí¬ ì •ì˜ ë° ì„œë¹„ìŠ¤ ë„¤íŠ¸ì›Œí¬ ì„¤ì •
- ì„œë¹„ìŠ¤ëŠ” ì´ë¦„ë§Œ ë§ì¶”ë©´ ë³‘í•© ì‹œ ìë™ ì—°ê²°ë¨

# ì„œë¹„ìŠ¤(ì»¨í…Œì´ë„ˆ) ì‹¤í–‰ ë°©ë²•

## ë¡œì»¬ (ê°œë°œììš©)

```bash
docker compose --env-file .env up -d
```

- Composeê°€ ìë™ìœ¼ë¡œ `default` ë„¤íŠ¸ì›Œí¬ ìƒì„± ë° ì—°ê²°

## ê°œë°œ ì„œë²„

### ë‹¨ì¼ ì„œë¹„ìŠ¤ ì‹¤í–‰

```bash
docker compose \
  -f ../docker-compose.common.yml \
  -f docker-compose.yml \
  --env-file .env \
  up -d
```

- `docker-compose.common.yml`ì˜ ë„¤íŠ¸ì›Œí¬ ì„¤ì •ì´ ë³‘í•©ë˜ë©´ì„œ
- ì„œë¹„ìŠ¤ê°€ `msa-net`ì— ì •ìƒ ì—°ê²°ë¨

### ì „ì²´ ì„œë¹„ìŠ¤ ì‹¤í–‰ (`scripts/start-all.sh`)

```bash
#!/bin/bash
set -e

COMMON_COMPOSE_FILE="../docker-compose.common.yml"

echo "=== ì „ì²´ ì„œë¹„ìŠ¤ ì‹¤í–‰ ì‹œì‘ ==="

for SERVICE_DIR in ../*/ ; do
  if [[ -f "$SERVICE_DIR/docker-compose.yml" && -f "$SERVICE_DIR/.env" ]]; then
    echo "ğŸš€ ì‹¤í–‰ ì¤‘: $SERVICE_DIR"
    docker compose \
      -f "$COMMON_COMPOSE_FILE" \
      -f "$SERVICE_DIR/docker-compose.yml" \
      --env-file "$SERVICE_DIR/.env" \
      up -d
  fi
done

echo "âœ… ì „ì²´ ì„œë¹„ìŠ¤ ì‹¤í–‰ ì™„ë£Œ"
```

- ìë™ìœ¼ë¡œ ë””ë ‰í† ë¦¬ë¥¼ í•˜ë‚˜ì”© ëŒì•„ê°€ë©° ì„œë¹„ìŠ¤ ì‹¤í–‰

### ì „ì²´ ì„œë¹„ìŠ¤ ì¤‘ì§€ (`scripts/stop-all.sh`)

```bash
#!/bin/bash
set -e

COMMON_COMPOSE_FILE="../docker-compose.common.yml"

echo "=== ì „ì²´ ì„œë¹„ìŠ¤ ì¤‘ì§€ ì‹œì‘ ==="

for SERVICE_DIR in ../*/ ; do
  if [[ -f "$SERVICE_DIR/docker-compose.yml" ]]; then
    echo "ğŸ›‘ ì¤‘ì§€ ì¤‘: $SERVICE_DIR"
    docker compose \
      -f "$COMMON_COMPOSE_FILE" \
      -f "$SERVICE_DIR/docker-compose.yml" \
      down
  fi
done

echo "âœ… ì „ì²´ ì„œë¹„ìŠ¤ ì¤‘ì§€ ì™„ë£Œ"
```

- ìë™ìœ¼ë¡œ ë””ë ‰í† ë¦¬ë¥¼ í•˜ë‚˜ì”© ëŒì•„ê°€ë©° ì„œë¹„ìŠ¤ ì¤‘ì§€
